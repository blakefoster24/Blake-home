- id: '1758434770896'
  alias: Flic Button
  description: ''
  triggers:
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Single
    alias: 'Flic single '
    id: Flic_Single Trigger
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Double
    id: Flic_Double Trigger
    alias: 'Flic double '
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Hold
    id: Flic_Hold Trigger
    alias: Flic hold
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Flic_Single Trigger
      sequence:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.main_lights
    - conditions:
      - condition: trigger
        id:
        - Flic_Double Trigger
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_lights
    - conditions:
      - condition: trigger
        id:
        - Flic_Hold Trigger
      - condition: state
        entity_id: binary_sensor.bed_presence_bb8594_bed_occupied_left
        state:
        - 'off'
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_off
  mode: single
- id: '1758990657332'
  alias: Living Room Lamp
  description: Control the living room lamp around sunset/sunrise and in sync with
    the main lights.
  triggers:
  - trigger: sun
    event: sunset
    offset: -01:00:00
    id: Sunset -1hr
    enabled: true
    alias: Sunset
  - trigger: sun
    event: sunrise
    offset: 00:30:00
    id: Sunrise +30min
    alias: Sunrise
  - type: value
    device_id: c01df91d71e0dd72fe7a5636aea2d71b
    entity_id: 43e53695c8962aaa2bf07e8ed7325df8
    domain: sensor
    trigger: device
    above: 40
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Cloud coverage >40
    alias: Clouds > 40%
  - type: value
    device_id: c01df91d71e0dd72fe7a5636aea2d71b
    entity_id: 43e53695c8962aaa2bf07e8ed7325df8
    domain: sensor
    trigger: device
    below: 30
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Cloud coverage <30
    alias: Clouds < 30%
  - trigger: state
    entity_id:
    - person.blake_foster
    to: home
    id: Blake’s home
  - trigger: state
    entity_id:
    - person.blake_foster
    to: not_home
    id: Blake away
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Cloud coverage >40
        - Sunset -1hr
        - Blake’s home
        alias: 'Triggered By: Sunset or Cloudy or Home'
      - alias: Sundown or Cloudy & Home
        condition: or
        conditions:
        - condition: sun
          before: sunrise
          after: sunset
          after_offset: -01:00:00
          before_offset: 00:30:00
          alias: Sundown
        - alias: Cloudy & Home
          condition: and
          conditions:
          - type: is_value
            condition: device
            device_id: c01df91d71e0dd72fe7a5636aea2d71b
            entity_id: 43e53695c8962aaa2bf07e8ed7325df8
            domain: sensor
            above: 38
            alias: Clouds > 38%
          - condition: state
            entity_id: person.blake_foster
            state: home
      sequence:
      - action: light.turn_on
        metadata: {}
        data:
          brightness_pct: 75
          transition: 0
        target:
          entity_id: light.living_room_lamp
      alias: Turn On Branch
    - conditions:
      - condition: trigger
        id:
        - Cloud coverage <30
        - Sunrise +30min
        - Blake away
        alias: 'Triggered By: Sunrise or Sunny or Away'
      - condition: not
        conditions:
        - condition: sun
          before: sunrise
          after: sunset
          before_offset: 00:30:00
          after_offset: -01:00:00
          alias: Sundown
      - condition: or
        conditions:
        - type: is_value
          condition: device
          device_id: c01df91d71e0dd72fe7a5636aea2d71b
          entity_id: 43e53695c8962aaa2bf07e8ed7325df8
          domain: sensor
          below: 32
          alias: Clouds < 32%
        - condition: state
          entity_id: person.blake_foster
          state: not_home
        alias: Sunny or Away
      sequence:
      - action: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.living_room_lamp
      alias: Turn off Branch
  trace:
    stored_traces: 50
  mode: single
- id: nightly_github_sync
  alias: Nightly GitHub sync
  description: Run snapshots + push every night at 2 AM
  triggers:
  - trigger: time
    at: 02:00:00
  actions:
  - action: script.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: script.create_push_ha_info_to_github_gemini_zip
  mode: single
- id: '1759838752481'
  alias: Light Automations
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - switch.bedroom_ceiling_lights
    to: 'on'
    id: Bedroom ceiling lights on
  - trigger: state
    entity_id:
    - binary_sensor.bed_presence_bb8594_bed_occupied_left
    id: Bed left
    to:
    - 'on'
    for:
      hours: 0
      minutes: 2
      seconds: 0
  - trigger: state
    entity_id:
    - binary_sensor.bed_presence_bb8594_bed_occupied_both
    to:
    - 'on'
    for:
      hours: 0
      minutes: 2
      seconds: 0
    id: Bed both
  - trigger: state
    entity_id:
    - binary_sensor.closet_motion
    id: Closet motion
  - trigger: state
    entity_id:
    - binary_sensor.bathroom_presence
    id: 'Bathroom presence '
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Bedroom ceiling lights on
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.full_lamp
      alias: Ceiling Light -> Lamp
    - conditions:
      - condition: trigger
        id:
        - Bed left
        - Bed both
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id:
            - Bed left
          sequence:
          - wait_template: '{{ is_state(''binary_sensor.bathroom_presence'', ''off'')

              and is_state(''binary_sensor.closet_motion'', ''off'')

              and is_state(''binary_sensor.kitchen_presence'', ''off'')

              and is_state(''binary_sensor.living_room_motion'', ''off'') }}'
            continue_on_timeout: false
            timeout: 00:10:00
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.lights_off_except_bedroom
            data: {}
        - conditions:
          - condition: trigger
            id:
            - Bed both
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.lights_off_except_bedroom
            data: {}
    - conditions:
      - condition: trigger
        id:
        - Closet motion
      sequence:
      - if:
        - condition: state
          entity_id: binary_sensor.closet_motion
          state:
          - 'on'
        then:
        - action: light.turn_on
          metadata: {}
          target:
            entity_id: light.closet_light
          data: {}
        else:
        - action: light.turn_off
          metadata: {}
          target:
            entity_id: light.closet_light
          data: {}
    - conditions:
      - condition: trigger
        id:
        - 'Bathroom presence '
      sequence:
      - if:
        - condition: state
          entity_id: binary_sensor.bathroom_presence
          state:
          - 'on'
        then:
        - action: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.bathroom_light
        else:
        - action: light.turn_off
          metadata: {}
          data: {}
          target:
            entity_id: light.bathroom_light
  mode: restart
- id: '1760424497591'
  alias: Thermostat
  description: ''
  triggers:
  - trigger: time
    at: 09:00:00
    id: Morning Time Window
  - trigger: time
    at: '16:00:00'
    id: Afternoon Time Window
  - trigger: time
    at: '22:00:00'
    id: Night Time Window
  - trigger: state
    entity_id:
    - person.blake_foster
    to: home
    id: Blake’s home
  - trigger: state
    entity_id:
    - person.blake_foster
    to: not_home
    id: Blake away
  - alias: 64 > Thermostat Temperature > 76
    trigger: template
    value_template: "{{ states('sensor.nest_thermostat_temperature') | float > 76
      \n   or states('sensor.nest_thermostat_temperature') | float < 64 }}\n"
    id: 64 > Thermostat Temperature > 76
  - alias: Temperature > 5* from Setpoint
    trigger: template
    value_template: "{% set current = states('sensor.nest_thermostat_temperature')
      | float(0) %}\n{% set target = state_attr('climate.nest_thermostat', 'temperature')
      %}\n{% set high = state_attr('climate.nest_thermostat', 'target_temp_high')
      %}\n{% set low = state_attr('climate.nest_thermostat', 'target_temp_low') %}\n\n{%
      if target != None %}\n  {{ (current - target) | abs > 5 }}\n{% elif high !=
      None and low != None %}\n  {{ (current > high + 5) or (current < low - 5) }}\n{%
      else %}\n  false\n{% endif %}\n"
    id: Set-point discrepancy
    for:
      hours: 0
      minutes: 20
      seconds: 0
  conditions:
  - condition: or
    conditions:
    - condition: state
      entity_id: script.temporary_thermostat_adjustment
      state:
      - 'off'
    - condition: trigger
      id:
      - Set-point discrepancy
      - 64 > Thermostat Temperature > 76
      - Expansion C
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Blake away
      - condition: state
        entity_id: input_boolean.workday_today_toggle
        state: 'on'
      - condition: time
        after: 08:59:00
        before: '15:50:00'
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.thermostat_away
      alias: Away Branch
    - conditions:
      - condition: or
        conditions:
        - alias: 9am ≠ Workday
          condition: and
          conditions:
          - condition: trigger
            id:
            - Morning Time Window
          - condition: state
            entity_id: input_boolean.workday_today_toggle
            state: 'off'
        - alias: Blake Home 9am-4pm
          condition: and
          conditions:
          - condition: trigger
            id:
            - Blake’s home
          - condition: state
            entity_id: input_boolean.workday_today_toggle
            state:
            - 'on'
          - condition: time
            after: 08:59:00
            before: '15:50:00'
        - condition: and
          conditions:
          - condition: time
            after: 08:59:00
            before: '16:00:00'
          - condition: not
            conditions:
            - condition: trigger
              id:
              - Blake’s home
              - Blake away
              - 64 > Thermostat Temperature > 76
              - Set-point discrepancy
              - Expansion C
              - Morning Time Window
              - Afternoon Time Window
              - Night Time Window
          alias: 8am - 4pm not trigger
      sequence:
      - choose:
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 51
          sequence:
          - alias: Heat 70
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat
              temperature: 70
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 68
            above: 50
          sequence:
          - alias: Heat/Cool - 67/70
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat_cool
              target_temp_high: 70
              target_temp_low: 67
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            above: 67
          sequence:
          - alias: Cool - 67
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: cool
              temperature: 67
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
      alias: Morning Branch
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - Afternoon Time Window
        - alias: 4pm-9:59pm - not trigger
          condition: and
          conditions:
          - condition: time
            after: '15:59:00'
            before: '22:00:00'
          - condition: not
            conditions:
            - condition: trigger
              id:
              - Blake’s home
              - Blake away
              - 64 > Thermostat Temperature > 76
              - Set-point discrepancy
              - Expansion C
              - Morning Time Window
              - Afternoon Time Window
              - Night Time Window
      sequence:
      - choose:
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 61
          sequence:
          - alias: Heat 70
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat
              temperature: 70
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 80
            above: 60
          sequence:
          - alias: Heat/Cool - 68/72
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat_cool
              target_temp_high: 70
              target_temp_low: 67
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            above: 79
          sequence:
          - alias: Cool - 68
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: cool
              temperature: 68
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
      alias: Evening Branch
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - Night Time Window
        - alias: 9pm-9am - not trigger
          condition: and
          conditions:
          - condition: time
            after: '21:59:00'
            before: 09:00:00
          - condition: not
            conditions:
            - condition: trigger
              id:
              - Blake’s home
              - Blake away
              - 64 > Thermostat Temperature > 76
              - Set-point discrepancy
              - Expansion C
              - Morning Time Window
              - Afternoon Time Window
              - Night Time Window
      sequence:
      - choose:
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 61
          sequence:
          - alias: Heat 70
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat
              temperature: 70
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            below: 80
            above: 60
          sequence:
          - alias: Heat/Cool - 68/72
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: heat_cool
              target_temp_high: 70
              target_temp_low: 67
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
        - conditions:
          - condition: numeric_state
            entity_id: sensor.openweathermap_temperature_2
            above: 79
          sequence:
          - alias: Cool - 69
            action: climate.set_temperature
            metadata: {}
            data:
              hvac_mode: cool
              temperature: 68
            target:
              device_id: b43f8797bfe54ded21e44c051fec8167
      alias: Night Branch
    - conditions: []
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id:
            - 64 > Thermostat Temperature > 76
          - condition: state
            entity_id: person.blake_foster
            state:
            - home
          sequence:
          - action: scene.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: scene.thermostat_ideal_evening
        - conditions:
          - condition: trigger
            id:
            - Set-point discrepancy
          sequence:
          - action: notify.mobile_app_blakes_iphone
            metadata: {}
            data:
              message: 'Current temperature is: {{ states(''sensor.nest_thermostat_temperature'')
                | float | round | int }}°'
              title: Check Thermostat!
              data:
                push:
                  sound:
                    name: default
                    critical: 1
                    volume: 0.5
      alias: Temperature Issue
  trace:
    stored_traces: 50
  mode: single
- id: '1761198863619'
  alias: Helper Automation
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - person.blake_foster
    to:
    - home
    id: Blake Home
  - trigger: state
    entity_id:
    - binary_sensor.front_door
    to:
    - 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Stuck open
  - trigger: state
    entity_id:
    - binary_sensor.motion_1_motion
    to:
    - 'on'
    for:
      hours: 0
      minutes: 15
      seconds: 0
    id: Motion stuck
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Blake Home
      sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.home_timestamp
        data:
          datetime: '{{ now().isoformat() }}'
        alias: Set Home Timestamp
    - conditions:
      - condition: trigger
        id:
        - Stuck open
      sequence:
      - action: counter.increment
        metadata: {}
        data: {}
        target:
          entity_id: counter.door_stuck
      - action: notify.mobile_app_blakes_iphone
        metadata: {}
        data:
          message: Front door sensor still open
          data:
            interruption-level: time-sensitive
          title: Door Did Not Close
    - conditions:
      - condition: trigger
        id:
        - Motion stuck
      sequence:
      - action: counter.increment
        metadata: {}
        target:
          entity_id: counter.motion_anomaly
        data: {}
      - action: notify.mobile_app_blakes_iphone
        metadata: {}
        data:
          data:
            interruption-level: time-sensitive
          title: Motion stuck on detected
          message: 'Check motion sensor '
  mode: restart
- id: '1761312420129'
  alias: 'Battery Low Automation '
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.blakes_iphone_battery_level
    below: 11
    id: iPhone battery
  - trigger: numeric_state
    entity_id:
    - sensor.ipad_battery_level
    below: 11
    id: iPad battery
  conditions: []
  actions:
  - action: scene.create
    metadata: {}
    data:
      scene_id: lamp_snapshot
      snapshot_entities:
      - light.bedroom_lamp
  - choose:
    - conditions:
      - condition: trigger
        id:
        - iPhone battery
      sequence:
      - repeat:
          count: 2
          sequence:
          - action: light.toggle
            metadata: {}
            target:
              entity_id: light.bedroom_lamp
            data:
              transition: 0
          - delay:
              hours: 0
              minutes: 0
              seconds: 0
              milliseconds: 500
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.lamp_snapshot
            data:
              transition: 0
          - delay:
              hours: 0
              minutes: 0
              seconds: 0
              milliseconds: 500
    - conditions:
      - condition: trigger
        id:
        - iPad battery
      sequence:
      - repeat:
          count: 3
          sequence:
          - action: light.toggle
            metadata: {}
            target:
              entity_id: light.bedroom_lamp
            data:
              transition: 0
          - delay:
              hours: 0
              minutes: 0
              seconds: 0
              milliseconds: 500
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.lamp_snapshot
            data:
              transition: 0
          - delay:
              hours: 0
              minutes: 0
              seconds: 0
              milliseconds: 500
  - action: scene.delete
    metadata: {}
    target:
      entity_id: scene.lamp_snapshot
    data: {}
  mode: single
- id: '1761579203292'
  alias: Goodnight
  description: ''
  triggers:
  - trigger: time
    at: 01:00:00
  - trigger: state
    entity_id:
    - media_player.bedroom_tv
    to: idle
    for:
      hours: 0
      minutes: 20
      seconds: 0
  - trigger: state
    entity_id:
    - input_boolean.phone_active
    to: 'off'
    for:
      hours: 0
      minutes: 20
      seconds: 0
  conditions:
  - condition: time
    after: '22:00:00'
    before: 08:00:00
  - condition: state
    entity_id: media_player.bedroom_tv
    state: idle
    for:
      hours: 0
      minutes: 15
      seconds: 0
    alias: Bedroom Tv Idle > 15 min
  - condition: state
    entity_id: input_boolean.phone_active
    state: 'off'
    for:
      hours: 0
      minutes: 19
      seconds: 0
  - condition: state
    entity_id: person.blake_foster
    state:
    - home
    for:
      hours: 0
      minutes: 30
      seconds: 0
  - condition: state
    entity_id: binary_sensor.bed_presence_bb8594_bed_occupied_left
    state:
    - 'on'
  actions:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.goodnight_scene
  trace:
    stored_traces: 50
  mode: single
- id: '1762858969202'
  alias: Door Automation
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.front_door
    to:
    - 'on'
  conditions: []
  actions:
  - alias: Logic
    sequence:
    - variables:
        presence_ts: "{% if is_state('binary_sensor.kitchen_presence', 'on') %}\n
          \ {{ as_timestamp(states.binary_sensor.kitchen_presence.last_changed) }}\n{%
          else %}\n  0\n{% endif %}\n"
        door_open_trigger: '{{ as_timestamp(trigger.to_state.last_changed) if trigger
          is defined else now().timestamp() }}

          '
        prev_door_ts: '{{ state_attr(''input_datetime.last_door_open'',''timestamp'')
          }}

          '
        home_ts: "{% if is_state('person.blake_foster','home') %}\n  {{ state_attr('input_datetime.home_timestamp',
          'timestamp') }}\n{% else %}\n  0\n{% endif %}\n"
    - action: input_datetime.set_datetime
      metadata: {}
      data:
        datetime: '{{ now().isoformat() }}'
      target:
        entity_id: input_datetime.last_door_open
    - alias: Log Variables
      action: logbook.log
      metadata: {}
      data:
        name: "{% if presence_ts is number and presence_ts > 0 %}\n  {% set motion_delta
          = (door_open_trigger - presence_ts) | round(2) %}\n  {% set direction =
          'leaving' if motion_delta > 0 else 'arriving' %}\n{% else %}\n  {% set motion_delta
          = 'n/a' %}\n  {% set direction = 'arriving' %}\n{% endif %}\n{% if home_ts
          is number and home_ts > 0 and prev_door_ts is number and prev_door_ts >
          0 %}\n  {% set home_delta = (home_ts - prev_door_ts) | round(2) %}\n  {%
          set first_open_bool = home_delta > 0 %}\n{% else %}\n  {% set home_delta
          = 'n/a' %}\n  {% set first_open_bool = 'n/a' %}\n{% endif %}\n{{ direction
          | capitalize }} | Δmotion: {{ motion_delta }}s | first opening: {{ true
          if first_open_bool == true else false if first_open_bool == false else 'n/a'
          }} | Δhome: {{ home_delta }}s"
        message: "{% if presence_ts is number and presence_ts > 0 %}\n  {% set motion_delta
          = (door_open_trigger - presence_ts) | round(2) %}\n  {% set direction =
          'leaving' if motion_delta > 0 else 'arriving' %}\n{% else %}\n  {% set motion_delta
          = 'n/a' %}\n  {% set direction = 'arriving' %}\n{% endif %}\n{% if home_ts
          is number and home_ts > 0 and prev_door_ts is number and prev_door_ts >
          0 %}\n  {% set home_delta = (home_ts - prev_door_ts) | round(2) %}\n  {%
          set first_open_bool = home_delta > 0 %}\n{% else %}\n  {% set home_delta
          = 'n/a' %}\n  {% set first_open_bool = 'n/a' %}\n{% endif %}\n{% set valid_ts
          = [door_open_trigger, home_ts, prev_door_ts]\n   | select('number') | select('gt',
          0) | list %}\n{% set dates = valid_ts\n   | map('timestamp_custom', '%Y-%m-%d')\n
          \  | list %}\n{% set unique_dates = dates | unique | list %} {% set show_dates
          = (unique_dates | length) > 1 %}\n{% macro fmt(ts) %}\n  {% if ts is number
          and ts > 0 %}\n    {% if show_dates %}\n      {{ ts | timestamp_custom('%Y-%m-%d
          %I:%M:%S %p') }}\n    {% else %}\n      {{ ts | timestamp_custom('%I:%M:%S
          %p') }}\n    {% endif %}\n  {% else %}\n    n/a\n  {% endif %}\n{% endmacro
          %}\n[DIRECTION LOGIC] | Door_open_trigger: {{ fmt(door_open_trigger) }}
          | Presence_ts: {{ fmt(presence_ts) }} | Door_open_trigger - Presence_ts
          = {{ motion_delta }}s | Direction: {{ direction }} |\n[FIRST OPENING LOGIC]
          | Home_ts: {{ fmt(home_ts) }} | Prev_door_ts: {{ fmt(prev_door_ts) }} |
          Home_ts - Prev_door_ts = {{ home_delta }}s | First opening: {{ true if first_open_bool
          == true else false if first_open_bool == false else 'n/a' }}\n"
  - alias: Leaving / Arriving
    choose:
    - conditions:
      - alias: True = Leaving (Presence TS < Door open TS)
        condition: template
        value_template: '{{ presence_ts is number and presence_ts > 0 and presence_ts
          < door_open_trigger }}'
      sequence:
      - alias: Apt Presence off for 5 minutes
        wait_template: "{{ is_state('binary_sensor.apartment_presence', 'off') and
          \n   (now() - states.binary_sensor.apartment_presence.last_changed).total_seconds()
          > 350 }}"
        continue_on_timeout: true
        timeout: 00:10
      - alias: Apt presence wait results
        choose:
        - conditions:
          - alias: Apt Presence wait passed
            condition: template
            value_template: '{{ wait.completed }}'
          sequence:
          - action: scene.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: scene.all_off
          - action: notify.mobile_app_blakes_iphone
            metadata: {}
            data:
              message: Everything’s off!
              title: Goodbye
              data:
                interruption level: time-sensitive
          alias: Apt presence wait passed
        - conditions:
          - alias: Apt Presence wait failed
            condition: template
            value_template: '{{ not wait.completed }}'
          sequence:
          - wait_for_trigger:
            - trigger: state
              entity_id:
              - binary_sensor.bed_presence_bb8594_bed_occupied_either
              for:
                hours: 0
                minutes: 4
                seconds: 0
              to:
              - 'on'
            timeout:
              hours: 0
              minutes: 10
              seconds: 0
              milliseconds: 0
            continue_on_timeout: false
          - action: light.turn_off
            metadata: {}
            target:
              entity_id:
              - light.main_lights
              - light.kitchen_lights
              - light.living_room_ceiling_lights
              - light.bathroom_light
              - light.closet_light
            data: {}
          alias: Apt presence wait timed out
      alias: Leaving Branch
    - conditions:
      - condition: not
        conditions:
        - alias: True = Leaving (Presence TS < Door open TS)
          condition: template
          value_template: '{{ presence_ts is number and presence_ts > 0 and presence_ts
            < door_open_trigger }}'
        alias: Not  (leaving logic)
      sequence:
      - alias: First Opening
        if:
        - condition: template
          alias: First door open since "home"
          value_template: '{{ home_ts > 0 and prev_door_ts is number and home_ts >
            prev_door_ts }}'
        then:
        - action: scene.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: scene.all_lights
        - action: media_player.play_media
          metadata: {}
          data:
            media:
              media_content_id: '837'
              media_content_type: app
              metadata:
                title: YouTube
                thumbnail: http://192.168.1.68:8060/query/icon/837
                media_class: app
                children_media_class:
                navigateIds:
                - {}
                - media_content_type: apps
                  media_content_id: ''
                browse_entity_id: media_player.bedroom_tv
          target:
            entity_id: media_player.bedroom_tv
        - alias: Rachel arrives = fan on
          if:
          - condition: template
            value_template: "{{ is_state('person.rachel', 'home') \n   and (now()
              - states.person.rachel.last_changed).total_seconds() < 300 \n   and
              (now() - states('sensor.uptime') | as_datetime | default(now())).total_seconds()
              > 300 }}\n"
            alias: Rachel arrived < 5 minutes
          then:
          - action: fan.turn_on
            metadata: {}
            target:
              entity_id: fan.bedroom_ceiling_fan
            data: {}
        else:
        - action: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.main_lights
        - alias: Rachel arrives = fan on
          if:
          - condition: template
            value_template: "{{ is_state('person.rachel', 'home') \n   and (now()
              - states.person.rachel.last_changed).total_seconds() < 300 \n   and
              (now() - states('sensor.uptime') | as_datetime | default(now())).total_seconds()
              > 300 }}\n"
            alias: Rachel arrived < 5 minutes
          then:
          - action: fan.turn_on
            metadata: {}
            target:
              entity_id: fan.bedroom_ceiling_fan
            data: {}
        - wait_for_trigger:
          - trigger: state
            entity_id:
            - binary_sensor.bed_presence_bb8594_bed_occupied_both
            for:
              hours: 0
              minutes: 2
              seconds: 0
            to:
            - 'on'
          timeout:
            hours: 0
            minutes: 20
            seconds: 0
            milliseconds: 0
          continue_on_timeout: false
        - action: light.turn_off
          metadata: {}
          data: {}
          target:
            entity_id:
            - light.main_lights
            - light.living_room_ceiling_lights
            - light.kitchen_lights
      alias: Arriving branch
  trace:
    stored_traces: 50
  mode: restart
- id: '1763883487543'
  alias: Bedroom Ceiling Lights (3) -> Set My Room
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - light.bedroom_ceiling_lights
  conditions: []
  actions:
  - wait_for_trigger:
    - trigger: state
      entity_id:
      - light.bedroom_ceiling_lights
    timeout:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
    continue_on_timeout: false
  - wait_for_trigger:
    - trigger: state
      entity_id:
      - light.bedroom_ceiling_lights
    timeout:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
    continue_on_timeout: false
  - action: script.turn_on
    metadata: {}
    target:
      entity_id: script.set_room_2
    data: {}
  mode: single
- id: '1764120623172'
  alias: Work Schedule Automations
  description: ''
  triggers:
  - trigger: time
    at: 00:01:00
    id: '12:01'
  - trigger: time
    at: 09:45:00
    id: 9:45am
  - trigger: time
    at: '23:00:00'
    id: 11pm
  - trigger: time
    at: '13:00:00'
    id: 1pm
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 1pm
      sequence:
      - alias: 'Workday Schedule '
        if:
        - condition: or
          conditions:
          - condition: state
            state: 'on'
            entity_id: binary_sensor.workday_tomorrow_template_sensor
          - condition: template
            value_template: '{{ states(''input_datetime.working_override'') == (now()
              + timedelta(days=1)).strftime(''%Y-%m-%d'') }}

              '
            alias: Working Override = Tomorrow
          alias: Work tomorrow sensor OR work override = tomorrow
        - alias: Tomorrow is NOT scheduled off
          condition: not
          conditions:
          - alias: Scheduled Off = Tomorrow
            condition: template
            value_template: "{% set comp = states('input_datetime.scheduled_off')
              %}\n{% if comp in ['unknown', 'unavailable', 'none', ''] %}\n  false\n{%
              else %}\n  {% set tomorrow = (now().date() + timedelta(days=1)).strftime('%Y-%m-%d')
              %}\n  {{ comp == tomorrow }}\n{% endif %}"
        then:
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.workday_tomorrow_toggle
        else:
        - action: input_boolean.turn_off
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.workday_tomorrow_toggle
      alias: 1pm set workday tomorrow toggle
    - conditions:
      - condition: trigger
        id:
        - 11pm
      sequence:
      - alias: Workday tomorrow toggle -> alarms
        if:
        - condition: state
          state: 'on'
          entity_id: input_boolean.workday_tomorrow_toggle
        then:
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id:
            - input_boolean.workday_today_toggle
        - action: notify.blake_foster30_gmail_com
          metadata: {}
          data:
            message: Work Alarm ON
            title: Work Alarm ON
            target: blake.foster30@gmail.com
        else:
        - action: input_boolean.turn_off
          metadata: {}
          data: {}
          target:
            entity_id:
            - input_boolean.workday_today_toggle
        - action: notify.blake_foster30_gmail_com
          metadata: {}
          data:
            message: Work Alarm OFF
            title: Work Alarm OFF
            target: blake.foster30@gmail.com
      alias: 11pm send shortcut email, set workday today toggle
    - conditions:
      - condition: trigger
        id:
        - '12:01'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ states(''input_datetime.scheduled_off'') == (now()
              - timedelta(days=1)).strftime(''%Y-%m-%d'') }}

              '
            alias: Scheduled Off = Yesterday
          sequence:
          - action: input_datetime.set_datetime
            metadata: {}
            data:
              timestamp: 0
            target:
              entity_id: input_datetime.scheduled_off
            alias: Clear Scheduled Off
        - conditions:
          - condition: template
            value_template: '{{ states(''input_datetime.working_override'') == (now()
              - timedelta(days=1)).strftime(''%Y-%m-%d'') }}

              '
            alias: Working Override = Yesterday
          sequence:
          - action: input_datetime.set_datetime
            metadata: {}
            data:
              timestamp: 0
            target:
              entity_id: input_datetime.working_override
            alias: Clear Working Override
        alias: Clear Work Override / Off Helpers
      alias: Clear Work Schedule Helpers
    - conditions:
      - condition: trigger
        id:
        - 9:45am
      - condition: template
        value_template: "{%- set worked = [\n  '2025-11-27','2026-05-25','2026-12-25','2027-07-04','2028-01-01',\n
          \ '2028-09-04','2029-01-15','2029-11-22','2030-05-27','2030-12-25'\n] -%}\n{%-
          set today = now().date() -%}\n{%- for d in worked -%}\n  {%- if (as_datetime(d
          ~ ' 00:00:00').date() - today).days == 7 -%}\n    true\n  {%- endif -%}\n{%-
          endfor -%}\nfalse"
        alias: Holiday in 7 days
        enabled: true
      sequence:
      - sequence:
        - action: notify.mobile_app_blakes_iphone
          metadata: {}
          data:
            title: You work a holiday next week
            message: 'Enter the date you want off (MM-DD-YYYY). Example: 11-27-2025'
            data:
              actions:
              - action: enter_comp_day_mmddyyyy
                title: Enter comp day
                behavior: textInput
                textInputButtonTitle: Save
                textInputPlaceholder: MM-DD-YYYY
          alias: Request holiday comp date
        - alias: Proper Date Loop
          repeat:
            until:
            - condition: template
              value_template: "{% if raw_input is defined and raw_input is string
                \n      and raw_input != '' \n      and (raw_input | regex_match('^\\\\d{1,2}-\\\\d{1,2}-\\\\d{4}$'))
                %}\n  {% set parts = raw_input.split('-') %}\n  {% set iso = parts[2]
                ~ '-' ~ parts[0].zfill(2) ~ '-' ~ parts[1].zfill(2) %}\n  {% set dt
                = as_datetime(iso ~ ' 00:00:00', default=None) %}\n  {{ dt is not
                none and dt.date() > now().date() }}\n{% else %}\n  {{ false }}\n{%
                endif %}"
              alias: Valid Date
            sequence:
            - alias: Wait For Notification Response
              wait_for_trigger:
              - trigger: event
                event_type: mobile_app_notification_action
                event_data:
                  action: enter_comp_day_mmddyyyy
              timeout:
                hours: 1
                minutes: 0
                seconds: 0
                milliseconds: 0
              continue_on_timeout: true
            - if:
              - condition: template
                value_template: '{{ wait.trigger is none }}'
                alias: 'Trigger times out '
              then:
              - stop: User did not reply within 1 hour. Stopping loop.
            - variables:
                raw_input: '{{ wait.trigger.event.data.reply_text | default('''')
                  | trim }}'
            - if:
              - condition: not
                conditions:
                - condition: template
                  value_template: "{% set ok = false %}\n{% if raw_input is string\n
                    \     and raw_input != ''\n      and (raw_input | regex_match('^\\\\d{1,2}-\\\\d{1,2}-\\\\d{4}$'))
                    %}\n  {% set parts = raw_input.split('-') %}\n  {% set mm = parts[0].zfill(2)
                    %}\n  {% set dd = parts[1].zfill(2) %}\n  {% set yyyy = parts[2]
                    %}\n  {% set iso = yyyy ~ '-' ~ mm ~ '-' ~ dd %}\n  {% set dt
                    = as_datetime(iso ~ ' 00:00:00', default=None) %}\n  {% if dt
                    is not none and dt.date() > now().date() %}\n    {% set ok = true
                    %}\n  {% endif %}\n{% endif %}\n{{ ok }}"
                  alias: Valid Date
                alias: (Not) Valid Date
              then:
              - alias: Request VALID Date
                action: notify.mobile_app_blakes_iphone
                metadata: {}
                data:
                  message: 'Enter the date you want off in the proper format (MM-DD-YYYY).
                    Example: 11-27-2025'
                  data:
                    tag: comp_day_prompt
                    actions:
                    - action: enter_comp_day_mmddyyyy
                      title: Enter comp day
                      behavior: textInput
                      textInputButtonTitle: Save
                      textInputPlaceholder: MM-DD-YYYY
                  title: Invalid date format
              else:
              - variables:
                  parts: '{{ raw_input.split(''-'') }}'
                  mm: '{{ parts[0].zfill(2) }}'
                  dd: '{{ parts[1].zfill(2) }}'
                  yyyy: '{{ parts[2] }}'
                  iso_date: '{{ yyyy ~ ''-'' ~ mm ~ ''-'' ~ dd }}'
              - action: input_datetime.set_datetime
                metadata: {}
                data:
                  date: '{{ iso_date }}'
                target:
                  entity_id: input_datetime.scheduled_off
              - alias: Notification = date set
                action: notify.mobile_app_blakes_iphone
                metadata: {}
                data:
                  message: Comp day set to {{ raw_input }}
      alias: Holiday Comp
  mode: parallel
  max: 10
- id: '1765185651976'
  alias: Hue Dimmer
  description: Test Hue dimmer via ZHA events
  triggers:
  - trigger: event
    id: on_short
    alias: on_short
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: on_short_release
  - trigger: event
    id: on_long
    alias: on_long
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: on_hold
  - trigger: event
    id: up_short
    alias: up_short
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: up_short_release
  - trigger: event
    id: up_long
    alias: up_long
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: up_hold
  - trigger: event
    id: down_short
    alias: down_short
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: down_short_release
  - trigger: event
    id: down_long
    alias: down_long
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: down_hold
  - trigger: event
    id: off_short
    alias: off_short
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: off_short_release
  - trigger: event
    id: off_long
    alias: off_long
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: off_hold
  conditions: []
  actions:
  - choose:
    - alias: On Button
      conditions:
      - condition: trigger
        id:
        - on_short
        - on_long
      sequence:
      - alias: On Short / Long
        choose:
        - conditions:
          - condition: trigger
            id: on_short
          - condition: not
            conditions:
            - alias: Workday & 8-9:30am
              condition: and
              conditions:
              - condition: state
                entity_id: input_boolean.workday_today_toggle
                state:
                - 'on'
              - condition: time
                after: 08:00:00
                before: 09:30:00
          sequence:
          - alias: Bedroom Tv on/off
            if:
            - condition: state
              entity_id: media_player.bedroom_tv
              state:
              - 'on'
            then:
            - alias: check lamp
              if:
              - condition: state
                entity_id: light.bedroom_lamp
                state:
                - 'on'
              then:
              - action: scene.apply
                metadata: {}
                data:
                  entities:
                    light.main_lights:
                      state: 'off'
                    light.bedroom_ceiling_lights:
                      state: 'off'
                    light.closet_light:
                      state: 'off'
                    light.bathroom_light:
                      state: 'off'
                    fan.bedroom_fan:
                      state: 'off'
                    fan.living_room_ceiling_fan:
                      state: 'off'
                    light.living_room_ceiling_lights:
                      state: 'off'
                    light.kitchen_lights:
                      state: 'off'
                alias: 'Set my room (without): Bedroom Tv & Lamp'
              else:
              - action: scene.apply
                metadata: {}
                data:
                  entities:
                    light.bedroom_lamp:
                      state: 'on'
                      color temp: 327
                    light.main_lights:
                      state: 'off'
                    light.bedroom_ceiling_lights:
                      state: 'off'
                    light.closet_light:
                      state: 'off'
                    light.bathroom_light:
                      state: 'off'
                    fan.bedroom_fan:
                      state: 'off'
                    fan.living_room_ceiling_fan:
                      state: 'off'
                    light.living_room_ceiling_lights:
                      state: 'off'
                    light.kitchen_lights:
                      state: 'off'
                alias: 'Set my room (without): Bedroom Tv'
            else:
            - alias: check lamp
              if:
              - condition: state
                entity_id: light.bedroom_lamp
                state:
                - 'on'
              then:
              - action: scene.apply
                metadata: {}
                data:
                  entities:
                    media_player.bedroom_tv:
                      state: 'on'
                      source: YouTube
                    light.main_lights:
                      state: 'off'
                    light.bedroom_ceiling_lights:
                      state: 'off'
                    light.closet_light:
                      state: 'off'
                    light.bathroom_light:
                      state: 'off'
                    fan.bedroom_fan:
                      state: 'off'
                    fan.living_room_ceiling_fan:
                      state: 'off'
                    light.living_room_ceiling_lights:
                      state: 'off'
                    light.kitchen_lights:
                      state: 'off'
              else:
              - action: scene.turn_on
                metadata: {}
                target:
                  entity_id: scene.set_my_room
                data: {}
          alias: On Short
        - conditions:
          - condition: trigger
            id:
            - on_long
          sequence:
          - action: script.turn_on
            metadata: {}
            target:
              entity_id: script.set_room_2
            data: {}
          alias: On Long
    - alias: Up Button
      conditions:
      - condition: trigger
        id:
        - up_short
        - up_long
      sequence:
      - alias: Up Short / Long
        choose:
        - conditions:
          - condition: trigger
            id: up_short
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.full_lamp
            data: {}
          - action: light.turn_off
            metadata: {}
            target:
              entity_id: light.bedroom_ceiling_lights
            data: {}
          alias: Up Short
        - conditions:
          - condition: trigger
            id:
            - up_long
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.dimmed
            data: {}
          alias: Up Long
    - alias: Down Button
      conditions:
      - condition: trigger
        id:
        - down_short
        - down_long
      sequence:
      - alias: Down Short / Long
        choose:
        - conditions:
          - condition: trigger
            id: down_short
          sequence:
          - action: fan.toggle
            metadata: {}
            target:
              entity_id: fan.bedroom_ceiling_fan
            data: {}
          alias: Down Short
        - conditions:
          - condition: trigger
            id:
            - down_long
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.lights_off_except_bedroom
            data: {}
          alias: Down Long
    - alias: Off Button
      conditions:
      - condition: trigger
        id:
        - off_short
        - off_long
      sequence:
      - alias: Off Short / Long
        choose:
        - conditions:
          - condition: trigger
            id: off_short
          - condition: state
            entity_id: input_boolean.disable_toggle
            state:
            - 'off'
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.bedroom_lights_off
            data: {}
          alias: Off Short
        - conditions:
          - condition: trigger
            id:
            - off_long
          sequence:
          - action: scene.turn_on
            metadata: {}
            target:
              entity_id: scene.goodnight_scene
            data: {}
          alias: Off Long
  mode: single
- id: '1768260220196'
  alias: New automation
  description: ''
  triggers:
  - trigger: event
    id: on_short
    alias: Hue Dimmer - On Short
    event_type: zha_event
    event_data:
      device_ieee: 00:17:88:01:02:18:b1:7a
      command: on_short_release
  - trigger: time
    at: 08:50:00
    id: Late Time Window
  conditions:
  - condition: state
    state: 'on'
    entity_id: input_boolean.workday_today_toggle
  - condition: time
    after: 08:00:00
    before: 09:30:00
  actions:
  - parallel:
    - alias: Wake Up Scene Sequence
      sequence:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.bathroom_light
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.closet_light
      - action: light.turn_on
        metadata: {}
        data:
          brightness_pct: 75
          transition: 15
        target:
          entity_id: light.bedroom_lamp
      - delay:
          hours: 0
          minutes: 0
          seconds: 5
          milliseconds: 0
      - action: fan.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: fan.bedroom_fan
      - action: light.turn_on
        metadata: {}
        data:
          brightness_pct: 100
          transition: 5
        target:
          entity_id: light.bedroom_lamp
      - wait_for_trigger:
        - trigger: time
          at: 08:40:00
      - action: light.turn_on
        metadata: {}
        data:
          rgb_color:
          - 255
          - 73
          - 0
          brightness: 255
        target:
          entity_id: light.bedroom_tv_backlight
      - wait_for_trigger:
        - trigger: time
          at: 08:50:00
      - action: light.turn_on
        metadata: {}
        data:
          rgb_color:
          - 255
          - 0
          - 0
          brightness: 255
        target:
          entity_id: light.bedroom_tv_backlight
      - wait_for_trigger:
        - trigger: time
          at: 08:55:00
      - action: alexa_devices.send_text_command
        metadata: {}
        data:
          device_id: ba7e4aed08d0947fa03068f398842568
          text_command: Turn on backlight late scene
      - action: light.turn_off
        metadata: {}
        target:
          entity_id: light.bedroom_tv_backlight
        data: {}
    - alias: Leaving Sequence
      sequence:
      - action: automation.turn_off
        target:
          entity_id: automation.door_automation
        data:
          stop_actions: true
      - alias: Wait for -> door open
        wait_for_trigger:
        - trigger: state
          entity_id:
          - binary_sensor.front_door
          to:
          - 'on'
        timeout:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
        continue_on_timeout: true
      - if:
        - condition: template
          value_template: '{{ wait.trigger is not none }}

            '
          alias: Trigger Fired
        then:
        - action: input_datetime.set_datetime
          metadata: {}
          data:
            datetime: '{{ now().isoformat() }}'
          target:
            entity_id: input_datetime.last_door_open
        alias: If triggered - Set door timestamp
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_off
      - action: alexa_devices.send_text_command
        metadata: {}
        data:
          device_id: ba7e4aed08d0947fa03068f398842568
          text_command: turn off Roku backlight
      - action: automation.turn_on
        target:
          entity_id: automation.door_automation
        data: {}
      - action: notify.mobile_app_blakes_iphone
        metadata: {}
        data:
          message: Everything’s off!
          title: Goodbye
          data:
            interruption level: time-sensitive
    - alias: Alarm script at 8:50
      sequence:
      - wait_for_trigger:
        - trigger: time
          at: 08:50:00
        continue_on_timeout: false
        timeout:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - wait_template: '{{ (as_timestamp(now()) - state_attr(''input_datetime.last_door_open'',''timestamp'')
          | default(0)) > 3600 }}

          '
        continue_on_timeout: false
        timeout: '30'
      - action: script.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: script.alarm_music_script
    - alias: Out of bed = weather
      sequence:
      - wait_for_trigger:
        - trigger: state
          entity_id:
          - binary_sensor.bed_presence_bb8594_bed_occupied_left
          from:
          - 'on'
          to:
          - 'off'
          for:
            hours: 0
            minutes: 0
            seconds: 3
        continue_on_timeout: false
        timeout:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - action: alexa_devices.send_text_command
        metadata: {}
        data:
          text_command: What’s the weather today?
          device_id: ba7e4aed08d0947fa03068f398842568
  mode: single
  trace:
    stored_traces: 50
- id: '1768690632254'
  alias: Work Attic Temperature Notifications
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.a_expansion_attic_temperature
    - sensor.nest_temperature_sensor_a_expansion_attic_sensor_temperature
    - sensor.d_expansion_attic_temperature
    - sensor.nest_temperature_sensor_d_expansion_attic_sensor_temperature
    - sensor.c_expansion_attic_temperature
    - sensor.nest_temperature_sensor_stairwell_g_temperature
    below: 44
    id: all sensors lowest
  - trigger: numeric_state
    entity_id:
    - sensor.a_expansion_attic_temperature
    - sensor.nest_temperature_sensor_a_expansion_attic_sensor_temperature
    - sensor.d_expansion_attic_temperature
    - sensor.nest_temperature_sensor_d_expansion_attic_sensor_temperature
    - sensor.c_expansion_attic_temperature
    - sensor.nest_temperature_sensor_stairwell_g_temperature
    for:
      hours: 0
      minutes: 20
      seconds: 0
    below: 48
    id: all sensors highest
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - all sensors highest
      sequence:
      - action: notify.mobile_app_blakes_iphone
        metadata: {}
        data:
          message: "{% set id = trigger.entity_id %}\n{% if 'a_expansion' in id %}\n
            \ {% set area = 'Expansion A' %}\n  {% set s1 = 'sensor.a_expansion_attic_temperature'
            %}\n  {% set s2 = 'sensor.nest_temperature_sensor_a_expansion_attic_sensor_temperature'
            %}\n{% elif 'c_expansion' in id or 'stairwell_g' in id %}\n  {% set area
            = 'Expansion C' %}\n  {% set s1 = 'sensor.c_expansion_attic_temperature'
            %}\n  {% set s2 = 'sensor.nest_temperature_sensor_stairwell_g_temperature'
            %}\n{% elif 'd_expansion' in id %}\n  {% set area = 'Expansion D' %}\n
            \ {% set s1 = 'sensor.d_expansion_attic_temperature' %}\n  {% set s2 =
            'sensor.nest_temperature_sensor_d_expansion_attic_sensor_temperature'
            %}\n{% endif %}\n\n{{ area }} Alert!\n{{ state_attr(s1, 'friendly_name')
            }}: {{ states(s1) | float | round | int }}°\n{{ state_attr(s2, 'friendly_name')
            }}: {{ states(s2) | float | round | int }}°\n"
          title: Attic Temperature Below 48!
          data:
            push:
              sound:
                name: default
                critical: 1
                volume: 1
    - conditions:
      - condition: trigger
        id:
        - all sensors lowest
      sequence:
      - action: notify.mobile_app_blakes_iphone
        metadata: {}
        data:
          message: "{% set id = trigger.entity_id %}\n{% if 'a_expansion' in id %}\n
            \ {% set area = 'Expansion A' %}\n  {% set s1 = 'sensor.a_expansion_attic_temperature'
            %}\n  {% set s2 = 'sensor.nest_temperature_sensor_a_expansion_attic_sensor_temperature'
            %}\n{% elif 'c_expansion' in id or 'stairwell_g' in id %}\n  {% set area
            = 'Expansion C' %}\n  {% set s1 = 'sensor.c_expansion_attic_temperature'
            %}\n  {% set s2 = 'sensor.nest_temperature_sensor_stairwell_g_temperature'
            %}\n{% elif 'd_expansion' in id %}\n  {% set area = 'Expansion D' %}\n
            \ {% set s1 = 'sensor.d_expansion_attic_temperature' %}\n  {% set s2 =
            'sensor.nest_temperature_sensor_d_expansion_attic_sensor_temperature'
            %}\n{% endif %}\n\n{{ area }} Alert!\n{{ state_attr(s1, 'friendly_name')
            }}: {{ states(s1) | float | round | int }}°\n{{ state_attr(s2, 'friendly_name')
            }}: {{ states(s2) | float | round | int }}°\n"
          title: Attic Temperature Below 44!!
          data:
            push:
              sound:
                name: default
                critical: 1
                volume: 1
  mode: single
- id: '1768967873851'
  alias: Washing Machine / Dryer
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.dryer
    - binary_sensor.washing_machine
    from:
    - 'on'
    to:
    - 'off'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  conditions:
  - condition: or
    conditions:
    - condition: template
      value_template: '{{ (trigger.to_state.last_changed - trigger.from_state.last_changed).total_seconds()
        > 300 }}

        '
  actions:
  - action: notify.mobile_app_blakes_iphone
    metadata: {}
    data:
      title: Laundrys Done!
      message: '{{ ''Washing Machine'' if ''washing'' in trigger.entity_id else ''Dryer''
        }} has finished'
  - sequence:
    - action: scene.create
      metadata: {}
      data:
        snapshot_entities:
        - media_player.blake_s_echo_spot
        scene_id: spot_snap
    - action: media_player.volume_set
      metadata: {}
      data:
        volume_level: 0.6
      target:
        entity_id: media_player.all_echo
    - delay:
        hours: 0
        minutes: 0
        seconds: 2
        milliseconds: 0
    - action: tts.cloud_say
      metadata: {}
      data:
        cache: false
        entity_id: '{% if is_state(''binary_sensor.bed_presence_bb8594_bed_occupied_left'',
          ''on'') %} media_player.blake_s_echo_spot {% elif is_state(''binary_sensor.kitchen_presence'',
          ''on'') %} media_player.blake_s_echo_dot {% else %} media_player.everywhere
          {% endif %}

          '
        message: '{{ ''Washing Machine'' if ''washing'' in trigger.entity_id else
          ''Dryer'' }} has finished!'
    - action: scene.turn_on
      metadata: {}
      target:
        entity_id: scene.spot_snap
      data: {}
    - action: scene.delete
      metadata: {}
      target:
        entity_id: scene.spot_snap
      data: {}
    - action: notify.send_message
      metadata: {}
      target:
        entity_id: notify.blake_s_echo_spot_announce
      data:
        message: 'Everything’s finished '
  mode: single
