- id: '1758434770896'
  alias: Flic Button
  description: ''
  triggers:
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Single
    alias: 'Flic single '
    id: Flic_Single Trigger
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Double
    id: Flic_Double Trigger
    alias: 'Flic double '
  - trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: true
    webhook_id: Flic_Hold
    id: Flic_Hold Trigger
    alias: Flic hold
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Flic_Single Trigger
      sequence:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.main_lights
    - conditions:
      - condition: trigger
        id:
        - Flic_Double Trigger
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_lights
    - conditions:
      - condition: trigger
        id:
        - Flic_Hold Trigger
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_off
  mode: single
- id: '1758990657332'
  alias: Living Room Lamp
  description: Control the living room lamp around sunset/sunrise and in sync with
    the main lights.
  triggers:
  - trigger: sun
    event: sunset
    offset: -01:00:00
    id: Sunset -1hr
    enabled: true
    alias: Sunset
  - trigger: sun
    event: sunrise
    offset: 00:30:00
    id: Sunrise +30min
    alias: Sunrise
  - type: value
    device_id: c01df91d71e0dd72fe7a5636aea2d71b
    entity_id: 43e53695c8962aaa2bf07e8ed7325df8
    domain: sensor
    trigger: device
    above: 40
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Cloud coverage >40
    alias: Clouds > 40%
  - type: value
    device_id: c01df91d71e0dd72fe7a5636aea2d71b
    entity_id: 43e53695c8962aaa2bf07e8ed7325df8
    domain: sensor
    trigger: device
    below: 30
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Cloud coverage <30
    alias: Clouds < 30%
  - trigger: state
    entity_id:
    - person.blake_foster
    to: home
    id: Blake’s home
  - trigger: state
    entity_id:
    - person.blake_foster
    to: not_home
    id: Blake away
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Cloud coverage >40
        - Sunset -1hr
        - Blake’s home
        alias: 'Triggered By: Sunset or Cloudy or Home'
      - alias: Sundown or Cloudy & Home
        condition: or
        conditions:
        - condition: sun
          before: sunrise
          after: sunset
          after_offset: -01:00:00
          before_offset: 00:30:00
          alias: Sundown
        - alias: Cloudy & Home
          condition: and
          conditions:
          - type: is_value
            condition: device
            device_id: c01df91d71e0dd72fe7a5636aea2d71b
            entity_id: 43e53695c8962aaa2bf07e8ed7325df8
            domain: sensor
            above: 38
            alias: Clouds > 38%
          - condition: state
            entity_id: person.blake_foster
            state: home
      sequence:
      - action: light.turn_on
        metadata: {}
        data:
          brightness_pct: 75
          transition: 0
        target:
          entity_id: light.living_room_lamp
      alias: Turn On Branch
    - conditions:
      - condition: trigger
        id:
        - Cloud coverage <30
        - Sunrise +30min
        - Blake away
        alias: 'Triggered By: Sunrise or Sunny or Away'
      - condition: not
        conditions:
        - condition: sun
          before: sunrise
          after: sunset
          before_offset: 00:30:00
          after_offset: -01:00:00
          alias: Sundown
      - condition: or
        conditions:
        - type: is_value
          condition: device
          device_id: c01df91d71e0dd72fe7a5636aea2d71b
          entity_id: 43e53695c8962aaa2bf07e8ed7325df8
          domain: sensor
          below: 32
          alias: Clouds < 32%
        - condition: state
          entity_id: person.blake_foster
          state: not_home
        alias: Sunny or Away
      sequence:
      - action: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.living_room_lamp
      alias: Turn off Branch
  mode: single
- id: nightly_github_sync
  alias: Nightly GitHub sync
  description: Run snapshots + push every night at 2 AM
  triggers:
  - trigger: time
    at: 02:00:00
  actions:
  - action: script.create_push_ha_info_to_github
    data: {}
  mode: single
- id: '1759452792193'
  alias: Bedroom Ceiling Lights (3) -> Set My Room
  description: ''
  use_blueprint:
    path: Custom/Toggle_blueprint.yaml
    input:
      source_entity: light.bedroom_ceiling_lights
      scene_target: scene.set_my_room
- id: '1759463858553'
  alias: Hue Dimmer Switch
  description: ''
  triggers:
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: short_release
    subtype: 1
    id: top_short
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: long_press
    subtype: 1
    id: top_long
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: short_release
    subtype: 2
    id: up_short
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: repeat
    subtype: 2
    id: up_repeat
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: long_press
    subtype: 2
    id: up_long
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: short_release
    subtype: 3
    id: down_short
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: repeat
    subtype: 3
    id: down_repeat
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: long_press
    subtype: 3
    id: down_long
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: short_release
    subtype: 4
    id: bottom_short
  - trigger: device
    device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: long_press
    subtype: 4
    id: bottom_long
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: top_short
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.set_my_room
    - conditions:
      - condition: trigger
        id: top_long
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.im_awake
    - conditions:
      - condition: trigger
        id: up_short
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.full_lamp
    - conditions:
      - condition: trigger
        id: up_repeat
      sequence: []
    - conditions:
      - condition: trigger
        id: up_long
      sequence:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id:
          - light.closet_light
    - conditions:
      - condition: trigger
        id: down_short
      sequence:
      - action: fan.toggle
        metadata: {}
        data: {}
        target:
          entity_id: fan.bedroom_ceiling_fan
    - conditions:
      - condition: trigger
        id: down_repeat
      sequence: []
    - conditions:
      - condition: trigger
        id: down_long
      sequence: []
    - conditions:
      - condition: trigger
        id: bottom_short
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_lights_off
    - conditions:
      - condition: trigger
        id: bottom_long
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.goodnight_scene
  mode: parallel
  max: 10
- id: '1759721039676'
  alias: 'Work Schedule Automations '
  description: ''
  triggers:
  - trigger: time
    at: '13:00:00'
    id: 1pm
  - trigger: time
    at: '23:00:00'
    id: 11pm
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 1pm
      sequence:
      - if:
        - condition: state
          state: 'on'
          entity_id: binary_sensor.workday_tomorrow_template_sensor
        then:
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.workday_tomorrow_toggle
        else:
        - action: input_boolean.turn_off
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.workday_tomorrow_toggle
    - conditions:
      - condition: trigger
        id:
        - 11pm
      sequence:
      - if:
        - condition: state
          state: 'on'
          entity_id: input_boolean.workday_tomorrow_toggle
        then:
        - action: notify.blake_foster30_gmail_com
          metadata: {}
          data:
            message: Work Alarm ON
            title: Work Alarm ON
            target: blake.foster30@gmail.com
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id:
            - input_boolean.workday_today_toggle
        else:
        - action: notify.blake_foster30_gmail_com
          metadata: {}
          data:
            message: Work Alarm OFF
            title: Work Alarm OFF
            target: blake.foster30@gmail.com
        - action: input_boolean.turn_off
          metadata: {}
          data: {}
          target:
            entity_id:
            - input_boolean.workday_today_toggle
  mode: single
- id: '1759838752481'
  alias: Light Triggers Light
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - light.closet_light
    to: 'on'
    id: Closet light on
  - trigger: state
    entity_id:
    - light.closet_light
    to: 'off'
    id: Closet light off
  - trigger: state
    entity_id:
    - light.bedroom_ceiling_lights
    to: 'on'
    id: Bedroom Lights
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Closet light on
      - condition: state
        entity_id: light.bathroom_light
        state: 'off'
      sequence:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.bathroom_light
      - action: input_boolean.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.workday_toggle_helper
      - delay:
          hours: 0
          minutes: 30
          seconds: 0
          milliseconds: 0
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.workday_toggle_helper
    - conditions:
      - condition: trigger
        id:
        - Closet light off
      - condition: state
        entity_id: input_boolean.workday_toggle_helper
        state: 'on'
      sequence:
      - action: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.bathroom_light
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.workday_toggle_helper
    - conditions:
      - condition: trigger
        id:
        - Bedroom Lights
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.full_lamp
  mode: restart
- id: '1760424497591'
  alias: Thermostat
  description: ''
  triggers:
  - trigger: time
    at: 09:00:00
    id: 9am
  - trigger: time
    at: '16:00:00'
    id: 4pm
  - trigger: state
    entity_id:
    - person.blake_foster
    to: home
    id: Blake’s home
  - trigger: state
    entity_id:
    - person.blake_foster
    to: not_home
    id: Blake away
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 9am
      sequence:
      - if:
        - condition: state
          entity_id: input_boolean.workday_today_toggle
          state: 'on'
        then:
        - action: scene.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: scene.thermostat_away
        else:
        - action: scene.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: scene.thermostat_ideal_morning
    - conditions:
      - condition: trigger
        id:
        - 4pm
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.thermostat_ideal_evening
    - conditions:
      - condition: trigger
        id:
        - Blake’s home
      - condition: time
        after: 08:59:00
        before: '15:50:00'
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.thermostat_ideal_morning
    - conditions:
      - condition: trigger
        id:
        - Blake away
      - condition: state
        entity_id: input_boolean.workday_today_toggle
        state: 'off'
      - condition: time
        after: 08:59:00
        before: '15:50:00'
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.thermostat_away
  mode: single
- id: '1761047102816'
  alias: Test Bay
  description: ''
  triggers:
  - trigger: event
    event_type: ''
    id: Manual trigger
  conditions:
  - condition: or
    conditions:
    - condition: numeric_state
      entity_id: input_number.test
      above: 10
    - condition: numeric_state
      entity_id: input_number.test
      above: 1
  actions:
  - action: automation.trigger
    target:
      entity_id: automation.workday_wake_up
    data:
      skip_condition: true
      variables:
        trigger:
          id: 8:55am
  mode: single
- id: '1761198863619'
  alias: Helper Automation
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.motion_1_motion
    to: 'on'
    id: Motion
  - trigger: state
    entity_id:
    - binary_sensor.motion_1_motion
    to: 'off'
    id: Clear
  - entity_id: sensor.blakes_iphone_battery_state
    trigger: state
    id: Phone trigger
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Motion
      sequence:
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          timestamp: '{{ now().timestamp() }}'
        target:
          entity_id: input_datetime.last_motion_on
    - conditions:
      - condition: trigger
        id:
        - Clear
      sequence:
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          timestamp: 0
        target:
          entity_id: input_datetime.last_motion_on
    - conditions:
      - condition: trigger
        id:
        - Phone trigger
      sequence:
      - if:
        - condition: template
          value_template: '{{ states(''sensor.blakes_iphone_battery_state'') in [''Charging'',''Full'']
            }}'
          alias: Phone Plugged In
        then:
        - action: notify.mobile_app_blakes_iphone
          data:
            message: request_location_update
        - delay:
            hours: 0
            minutes: 0
            seconds: 2
            milliseconds: 0
        - variables:
            miles: '{% set km = distance(''device_tracker.blakes_iphone'',''zone.home'')
              %} {{ ((km if km is number else 0) * 0.621371) | float(0) | round(3)
              }}

              '
        - action: input_number.set_value
          target:
            entity_id: input_number.phone_charging_distance
          data:
            value: '{{ miles }}'
        else:
        - action: input_number.set_value
          target:
            entity_id: input_number.phone_charging_distance
          data:
            value: 10
  mode: restart
- id: '1761312420129'
  alias: 'Battery Low Automation '
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.blakes_iphone_battery_level
    below: 11
    id: iPhone battery
  - trigger: numeric_state
    entity_id:
    - sensor.ipad_battery_level
    below: 11
    id: iPad battery
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - iPhone battery
      sequence:
      - repeat:
          count: 2
          sequence:
          - delay:
              hours: 0
              minutes: 0
              seconds: 1
              milliseconds: 0
          - action: light.turn_on
            metadata: {}
            data:
              flash: short
            target:
              entity_id: light.bedroom_lamp
    - conditions:
      - condition: trigger
        id:
        - iPad battery
      sequence:
      - repeat:
          count: 3
          sequence:
          - delay:
              hours: 0
              minutes: 0
              seconds: 1
              milliseconds: 0
          - action: light.turn_on
            metadata: {}
            data:
              flash: short
            target:
              entity_id: light.bedroom_lamp
  mode: single
- id: '1761579203292'
  alias: Goodnight
  description: ''
  triggers:
  - trigger: time
    at: 01:00:00
  - trigger: state
    entity_id:
    - media_player.bedroom_tv
    to: idle
    for:
      hours: 0
      minutes: 20
      seconds: 0
  - trigger: state
    entity_id:
    - input_boolean.phone_active
    to: 'off'
    for:
      hours: 0
      minutes: 20
      seconds: 0
  conditions:
  - condition: time
    after: '22:00:00'
    before: 06:00:00
  - condition: state
    entity_id: media_player.bedroom_tv
    state: idle
    for:
      hours: 0
      minutes: 15
      seconds: 0
    alias: Bedroom Tv Idle > 15 min
  - condition: state
    entity_id: input_boolean.phone_active
    state: 'off'
    for:
      hours: 0
      minutes: 19
      seconds: 0
    attribute: 'he be '
  actions:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.goodnight_scene
  mode: single
- id: '1762355968615'
  alias: Workday Wake-up
  description: ''
  triggers:
  - trigger: time
    at: 08:50:00
    id: 8:40am Time Trigger
  - trigger: time
    at: 08:55:00
    id: 8:55am
  - trigger: time
    at: 09:29:00
    id: '9:29'
  - trigger: state
    entity_id:
    - binary_sensor.front_door
    to: 'on'
    id: Door
  - device_id: 6e3f05f16e73548265ce22e622f4a268
    domain: hue
    type: long_press
    subtype: 1
    unique_id: cdb2dfb8-edb8-4c9a-83ef-5519e2338c0a
    trigger: device
    id: '1 Long press '
    alias: 1 Long Press (I’m awake Scene)
  conditions:
  - condition: state
    state: 'on'
    entity_id: input_boolean.workday_today_toggle
  - condition: time
    after: 08:00:00
    before: 09:30:00
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - '1 Long press '
      sequence:
      - sequence:
        - action: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.bathroom_light
        - action: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.closet_light
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.im_awake_toggle_helper
      alias: Wake up Sequence
    - conditions:
      - condition: trigger
        id:
        - 8:40am Time Trigger
      - condition: state
        entity_id: input_boolean.im_awake_toggle_helper
        state: 'off'
      sequence:
      - sequence:
        - event: hue_event
          event_data:
            device_id: 6e3f05f16e73548265ce22e622f4a268
            type: long_press
            subtype: 1
        alias: Trigger Wake-up Sequence
      alias: 8:40am & Helper Still Off
    - conditions:
      - condition: trigger
        id:
        - 8:55am
      - condition: template
        value_template: "{% set s = states.binary_sensor.front_door %} {{ s.state
          in ['unavailable', 'unknown']\n   or (as_timestamp(now()) - as_timestamp(s.last_changed))
          > 3600 }}\n"
        alias: Door hasn’t opened in the last hour
      sequence:
      - event: hue_event
        event_data:
          device_id: 6e3f05f16e73548265ce22e622f4a268
          type: long_press
          subtype: 1
        alias: Trigger Wake-up Sequence
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.bedroom_ceiling_lights
      - alias: Play Music Alexa
        sequence:
        - action: media_player.volume_set
          metadata: {}
          data:
            volume_level: 0.01
          target:
            entity_id: media_player.everywhere
        - action: media_player.media_next_track
          metadata: {}
          data: {}
          target:
            entity_id: media_player.everywhere
          enabled: true
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0
        - action: media_player.media_next_track
          metadata: {}
          data: {}
          target:
            entity_id: media_player.everywhere
          enabled: true
        - if:
          - condition: state
            entity_id: media_player.everywhere
            state: playing
          then: []
          else:
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.01
            target:
              entity_id:
              - media_player.blake_s_echo_pop
          - action: media_player.play_media
            metadata: {}
            data:
              media:
                media_content_id: music alarm
                media_content_type: routine
            target:
              entity_id:
              - media_player.blake_s_echo_pop
          - delay:
              hours: 0
              minutes: 0
              seconds: 2
              milliseconds: 0
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.01
            target:
              entity_id: media_player.everywhere
          - action: media_player.shuffle_set
            metadata: {}
            data:
              shuffle: true
            target:
              entity_id: media_player.everywhere
          - action: media_player.media_next_track
            metadata: {}
            data: {}
            target:
              entity_id: media_player.everywhere
            enabled: true
          alias: Music Playing Check
        - alias: Incrementally raise volume
          sequence:
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.02
            target:
              entity_id: media_player.everywhere
          - delay:
              hours: 0
              minutes: 0
              seconds: 2
              milliseconds: 0
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.05
            target:
              entity_id: media_player.everywhere
          - delay:
              hours: 0
              minutes: 0
              seconds: 2
              milliseconds: 0
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.1
            target:
              entity_id: media_player.everywhere
          - delay:
              hours: 0
              minutes: 0
              seconds: 2
              milliseconds: 0
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.12
            target:
              entity_id: media_player.everywhere
          - delay:
              hours: 0
              minutes: 0
              seconds: 2
              milliseconds: 0
          - action: media_player.volume_set
            metadata: {}
            data:
              volume_level: 0.15
            target:
              entity_id: media_player.everywhere
      alias: 8:55 & Haven’t Left
    - conditions:
      - condition: trigger
        id:
        - '9:29'
        - Door
      sequence:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_off
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.im_awake_toggle_helper
      - alias: 'Pause and Reset Volume on Alexa '
        sequence:
        - action: media_player.media_stop
          metadata: {}
          data: {}
          target:
            entity_id: media_player.everywhere
        - action: media_player.volume_set
          metadata: {}
          data:
            volume_level: 0.4
          target:
            entity_id: media_player.everywhere
      alias: Leaving Branch
  mode: parallel
- id: '1762858969202'
  alias: Door Automation
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.front_door
    to: 'on'
  conditions:
  - condition: not
    conditions:
    - condition: and
      conditions:
      - condition: state
        state: 'on'
        entity_id: input_boolean.workday_today_toggle
      - condition: time
        after: 08:15:00
        before: 09:30:00
      alias: 'Workday: 8:15-9:30 AM'
  actions:
  - variables:
      motion_ts: '{{ state_attr(''input_datetime.last_motion_on'',''timestamp'') }}'
      door_open_trigger: '{{ as_timestamp(trigger.to_state.last_changed) if trigger
        is defined else now().timestamp() }}'
      prev_door_ts: '{{ state_attr(''input_datetime.last_door_open'',''timestamp'')
        }}'
      home_ts: "{% if is_state('person.blake_foster','home') %}\n  {{ as_timestamp(states.person.blake_foster.last_changed)
        }}\n{% else %}\n  0\n{% endif %}\n"
  - alias: Log Variables
    action: logbook.log
    metadata: {}
    data:
      name: "{% if motion_ts is number and motion_ts > 0 %}\n  {% set motion_delta
        = (door_open_trigger - motion_ts) | round(2) %}\n  {% set direction = 'leaving'
        if motion_delta > 0 else 'arriving' %}\n{% else %}\n  {% set motion_delta
        = 'n/a' %}\n  {% set direction = 'arriving' %}\n{% endif %}\n{% if home_ts
        is number and home_ts > 0 and prev_door_ts is number and prev_door_ts > 0
        %}\n  {% set home_delta = (home_ts - prev_door_ts) | round(2) %}\n  {% set
        first_open_bool = home_delta > 0 %}\n{% else %}\n  {% set home_delta = 'n/a'
        %}\n  {% set first_open_bool = 'n/a' %}\n{% endif %}\n{{ direction | capitalize
        }} | Δmotion: {{ motion_delta }}s | first opening: {{ true if first_open_bool
        == true else false if first_open_bool == false else 'n/a' }} | Δhome: {{ home_delta
        }}s\n"
      message: "{% if motion_ts is number and motion_ts > 0 %}\n  {% set motion_delta
        = (door_open_trigger - motion_ts) | round(2) %}\n  {% set direction = 'leaving'
        if motion_delta > 0 else 'arriving' %}\n{% else %}\n  {% set motion_delta
        = 'n/a' %}\n  {% set direction = 'arriving' %}\n{% endif %}\n{% if home_ts
        is number and home_ts > 0 and prev_door_ts is number and prev_door_ts > 0
        %}\n  {% set home_delta = (home_ts - prev_door_ts) | round(2) %}\n  {% set
        first_open_bool = home_delta > 0 %}\n{% else %}\n  {% set home_delta = 'n/a'
        %}\n  {% set first_open_bool = 'n/a' %}\n{% endif %}\n{% set valid_ts = [door_open_trigger,
        motion_ts, home_ts, prev_door_ts]\n   | select('number') | select('gt', 0)
        | list %}\n{% set dates = valid_ts\n   | map('timestamp_custom', '%Y-%m-%d')\n
        \  | list %}\n{% set unique_dates = dates | unique | list %} {% set show_dates
        = (unique_dates | length) > 1 %}\n{% macro fmt(ts) %}\n  {% if ts is number
        and ts > 0 %}\n    {% if show_dates %}\n      {{ ts | timestamp_custom('%Y-%m-%d
        %I:%M:%S %p') }}\n    {% else %}\n      {{ ts | timestamp_custom('%I:%M:%S
        %p') }}\n    {% endif %}\n  {% else %}\n    n/a\n  {% endif %}\n{% endmacro
        %}\n[DIRECTION LOGIC] | Door_open_trigger: {{ fmt(door_open_trigger) }} |
        Motion_ts: {{ fmt(motion_ts) }} | Door_open_trigger - Motion_ts = {{ motion_delta
        }}s | Direction: {{ direction }} |\n[FIRST OPENING LOGIC] | Home_ts: {{ fmt(home_ts)
        }} | Prev_door_ts: {{ fmt(prev_door_ts) }} | Home_ts - Prev_door_ts = {{ home_delta
        }}s | First opening: {{ true if first_open_bool == true else false if first_open_bool
        == false else 'n/a' }}\n"
  - alias: Leaving Or Arriving
    if:
    - condition: template
      alias: True = Leaving (Motion TS < Door open TS)
      value_template: '{{ motion_ts is number and motion_ts > 0 and motion_ts < door_open_trigger
        }}'
    then:
    - alias: Leaving Branch
      if:
      - condition: and
        conditions:
        - condition: template
          alias: Phone plugged in
          value_template: '{{ states(''sensor.blakes_iphone_battery_state'') | lower
            in [''charging'', ''full''] }}'
        - condition: numeric_state
          entity_id: input_number.phone_charging_distance
          below: 0.1
        alias: Phone Charging & Close
      then:
      - action: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.main_lights
      else:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_off
    else:
    - if:
      - condition: template
        alias: First door open since "home"
        value_template: '{{ home_ts > 0 and prev_door_ts is number and home_ts > prev_door_ts
          }}'
      then:
      - action: scene.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: scene.all_lights
      - action: media_player.play_media
        metadata: {}
        data:
          media:
            media_content_id: '837'
            media_content_type: app
            metadata:
              title: YouTube
              thumbnail: http://192.168.1.68:8060/query/icon/837
              media_class: app
              children_media_class:
              navigateIds:
              - {}
              - media_content_type: apps
                media_content_id: ''
              browse_entity_id: media_player.bedroom_tv
        target:
          entity_id: media_player.bedroom_tv
      else:
      - action: light.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: light.main_lights
      - wait_for_trigger:
        - trigger: state
          entity_id:
          - binary_sensor.motion_1_motion
          to: 'off'
          for:
            hours: 0
            minutes: 3
            seconds: 0
      - action: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.main_lights
      alias: Arriving Branch
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      datetime: '{{ now().isoformat() }}'
    target:
      entity_id: input_datetime.last_door_open
  mode: single
